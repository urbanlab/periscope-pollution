<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Periscope - Pollution de l'air - Urban LAB</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="description" content="Periscope - Pollution de l'air - Urban LAB Workshop DSAA Villefontaine">
    <script src="https://aframe.io/releases/0.4.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe-text-component/0.4.2/aframe-text-component.js"></script>
    <script src="https://rawgit.com/squarefeet/ShaderParticleEngine/master/build/SPE.js"></script>
    <script src="./js/aframe-animation-component.min.js"></script>

    <script src='./js/pollution.js'></script>

  </head>
  <body>
    <a-scene >
      <a-assets>
        <img id="start" crossorigin="anonymous" src="img/play.png" >

        <img id="viseurAsset" crossorigin="anonymous" src="./img/viseur.png">
        <img id="moleculesAll" crossorigin="anonymous" src="./img/molecules-all.png">
        <img id="roomTexteAsset" crossorigin="anonymous" src="./img/room-texte.png">

        <video id="videoGaribaldi" src="./video/garibaldi.light.mp4" loop autoplay="false"></video>
        <video id="videoTest" src="./video/test.small.mp4" autoplay="false" loop="true"></video>
        <video id="videoRoomBeforeAction" src="./video/room-before-action.mp4" autoplay="false" loop="false"></video>
        <video id="videoRoomAfterAction" src="./video/room-after-action.mp4" autoplay="false" loop="false"></video>

        <a-asset-item id="murvegetal-obj" src="./assets/murvegetal.obj"></a-asset-item>
        <a-asset-item id="murvegetal-mtl" src="./assets/murvegetal.mtl"></a-asset-item>

      </a-assets>

      <!-- START button : play videos -->
      <a-entity position="0 2.2 4" camera look-controls wasd-controls>
        <a-plane
           position="0 0 -3"
           width="1"
           height="1"
           color="#FFF"
           shader: flat;
           cursor="fuse: true"
           src="#start"
           id="playVideos"
           transparent="true"
          >
        </a-plane>
      </a-entity>


      <!-- CURSOR -->
      <a-entity position="0 2.2 4">
         <a-entity camera look-controls wasd-controls>
           <a-plane
             position="0 0 -3"
             width=".5"
             height=".5"
             color="#FFF"
             cursor="fuse: true"
             src="#viseurAsset"
             id="viseur"
             transparent="true"
             visible="false"
             >
             <a-animation begin="click" easing="ease-in" attribute="scale"
                  fill="forwards" from="0.1 0.1 0.1" to="1 1 1" dur="150"></a-animation>
             <a-animation begin="fusing" easing="ease-in" attribute="scale"
                  fill="backwards" from="1 1 1" to="0.1 0.1 0.1" dur="1500"></a-animation>
         </a-plane>
        </a-entity>
      </a-entity>

      <!-- POLLUTION  -->
      <a-entity
        id="pollution"
        pollution="count:10000;multiplier:0.01;speed:0.5"
        >
      </a-entity>

      <!-- garibaldi -->
      <a-entity id="sceneRue" class="scene" visible="true">
        <a-videosphere
          id="videoPlayerGaribaldi"
          src="#videoGaribaldi"
          rotation="0 0 0"
          class="playable"
          >
        </a-videosphere>
        <a-entity
          id="mur"
          obj-model="obj: #murvegetal-obj; mtl: #murvegetal-mtl"
          position="2 -.5 14"
          rotation="0 -15 0"
          scale=".001 .001 .001"
          onclick="showSceneRoom()"
          visible="false"
        >
        </a-entity>
      </a-entity>

      <!-- interior -->
      <a-entity id="sceneRoom" class="scene" visible="false">
        <a-videosphere
          id="videoSceneRoomBeforeAction"
          src="#videoRoomBeforeAction"
          visible="true"
          rotation="0 0 0"
          >
        </a-videosphere>
        <a-videosphere
          id="videoSceneRoomAfterAction"
          src="#videoRoomAfterAction"
          visible="false"
          rotation="0 0 0"
          >
        </a-videosphere>

        <a-plane id="hidden-window"
          visible="false"
          position="100 10 3.9"
          rotation="0 -90 0"
          width="65"
          height="98"
          color="#FFF"
          onclick="removePollution()"
          >
          <a-animation
            attribute="material.color"
            from="cyan"
            to="cyan"
            dur="1000"
            direction="alternate"
            repeat="indefinite"
            >
          </a-animation>
          <a-animation
            attribute="material.opacity"
            from="0"
            to=".5"
            dur="1000"
            direction="alternate"
            repeat="indefinite"
            >
          </a-animation>
        </a-plane>

        <a-entity position="0 2.2 4" camera look-controls wasd-controls>
           <a-plane
             position="0 1.25 -3"
             width="2"
             height="2"
             src="#roomTexteAsset"
             transparent="true"
             id="roomTexte"
             visible="false"
             >
           </a-plane>
        </a-entity>

      <script type="text/javascript">

        var inited = false;

        document.addEventListener("touchend", initVideos)

        // play and pause all videos
        function initVideos() {

          var videos = document.querySelectorAll('video')
          console.log("click screen");
          if(!inited && videos.length) {
            console.log("init");
            inited = true;

            for(var i = 0; i < videos.length; i++) {
              videos[i].play();
            }

            setTimeout( function () {
              for(var i = 0; i < videos.length; i++) {
                videos[i].pause();
              }
              document.getElementById('videoGaribaldi').play()
              document.getElementById('playVideos').setAttribute('visible', false);
              showCursor()

              document.getElementById('mur').setAttribute('visible', true);
              document.removeEventListener("touchend", initVideos)
            },1000);
          }
        }

        function hideAllScenes() {
          var scenes = document.getElementsByClassName('scene')
          for(var i = 0; i < scenes.length; i++) {
            scenes[i].setAttribute('visible', 'false')
          }

          // hide pollution
          var pollution = document.getElementById("pollution")
          pollution.setAttribute("pollution", {"multiplier" : 0})

        }

        function showCursor() {
          document.getElementById('viseur').setAttribute('visible', true);
        }

        function hideCursor() {
          document.getElementById('viseur').setAttribute('visible', false);
        }

        function showSceneRue() {
          hideAllScenes() // reset
          document.getElementById("sceneRue").setAttribute('visible', true)
          document.getElementById("mur").setAttribute('visible', true)
        }

        function showSceneRoom() {
          hideAllScenes() // reset
          hideCursor()
          var sceneEl = document.getElementById("sceneRoom")
          sceneEl.setAttribute('visible', 'true')

          console.log("play room before");
          document.getElementById('videoRoomBeforeAction').currentTime = 0
          document.getElementById('videoSceneRoomBeforeAction').setAttribute('visible', true)
          document.getElementById('videoSceneRoomAfterAction').setAttribute('visible', false)
          document.getElementById('videoRoomBeforeAction').play();

          var pollutionEl = document.getElementById("pollution")
          pollutionEl.emit("pollutionFadeIn") // start the animation
        }

        function removePollution(sceneId) {
          console.log('remove pollution');
          var pollutionEl = document.getElementById("pollution")

          // hide window and play 2nd video
          document.getElementById("hidden-window").setAttribute("visible", false)
          document.getElementById('videoRoomAfterAction').currentTime = 0
          document.getElementById('videoSceneRoomBeforeAction').setAttribute('visible', 'false')
          document.getElementById('videoSceneRoomAfterAction').setAttribute('visible', 'true')
          document.getElementById('videoRoomAfterAction').play()

          pollutionEl.emit("pollutionFadeOut")
        }

        // events
        var sceneEl = document.getElementById("sceneRoom")

        sceneEl.addEventListener('pollutionReady', function () {
          console.log("pollution is ready !");
          // show window
          document.getElementById("hidden-window").setAttribute("visible", true)
          document.getElementById("roomTexte").setAttribute("visible", true)
          showCursor()
        });

        sceneEl.addEventListener('pollutionFinished', function () {
          console.log("pollution is finished !");
          showSceneRue()
        });

      </script>
    </a-scene>
  </body>
</html>
